<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMU Web Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
            color: #e5e7eb; /* Tailwind gray-200 */
            overflow: hidden; /* Prevent scrollbars */
        }
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(31, 41, 55, 0.8); /* gray-800 with transparency */
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(75, 85, 99, 0.5); /* gray-600 with transparency */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            max-width: 320px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: background-color 0.5s ease;
        }
        .status-disconnected { background-color: #ef4444; } /* red-500 */
        .status-connected { background-color: #22c55e; } /* green-500 */
    </style>
</head>
<body class="w-screen h-screen m-0 p-0 flex items-center justify-center">

    <div id="container" class="w-full h-full absolute top-0 left-0"></div>

    <div id="info-panel">
        <h1 class="text-xl font-bold mb-2 text-white">IMU Visualizer</h1>
        <div class="flex items-center mb-4">
            <span id="status-dot" class="status-dot status-disconnected"></span>
            <span id="status-text" class="text-sm text-gray-300">Disconnected</span>
        </div>
        <p class="text-sm text-gray-400 mb-4">Connect to the Arduino running the IMU sketch. Use 'Zero' to calibrate the initial orientation.</p>
        
        <div class="grid grid-cols-2 gap-3">
            <button id="connect-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Connect</button>
            <button id="zero-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200" disabled>Zero Position</button>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-700 text-sm text-gray-300 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <p class="font-semibold">Yaw:</p>
                <span id="yaw-val">0.00째</span>
            </div>
            <div class="flex justify-between items-center">
                <p class="font-semibold">Pitch:</p>
                <span id="pitch-val">0.00째</span>
            </div>
            <div class="flex justify-between items-center">
                <p class="font-semibold">Roll:</p>
                <span id="roll-val">0.00째</span>
            </div>
            <div class="flex justify-between items-center">
                <p class="font-semibold">Temp:</p>
                <span id="temp-val">0.00째 F</span>
            </div>
            <div class="flex justify-between items-center">
                <p class="font-semibold">Accel:</p>
                <span id="accel-val">0.00 G</span>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-700 text-xs text-gray-400">
            <p class="mb-2">Debug Info:</p>
            <div class="flex justify-between">
                <span>Quaternion Norm:</span>
                <span id="quat-norm">1.000</span>
            </div>
            <div class="flex justify-between mt-1">
                <span>Data Rate:</span>
                <span id="data-rate">0 Hz</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- 3D Scene Variables ---
        let scene, camera, renderer, modelGroup;
        
        // --- Serial Connection Variables ---
        let port, reader;
        let lineBuffer = '';

        // --- Sensor Data Variables ---
        let currentQuaternion = new THREE.Quaternion();
        let zeroOffsetQuaternion = new THREE.Quaternion();
        
        // --- Data rate tracking ---
        let lastDataTime = Date.now();
        let dataCount = 0;
        let dataRate = 0;

        // --- Initialization ---
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);
            scene.fog = new THREE.Fog(0x111827, 15, 40);

            // Camera setup
            const container = document.getElementById('container');
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 5);
            camera.lookAt(scene.position);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Create 3D objects
            createRocketModel();
            createLighting();
            createHelpers();
            
            // Add event listeners
            document.getElementById('connect-button').addEventListener('click', toggleSerialConnection);
            document.getElementById('zero-button').addEventListener('click', zeroPosition);
            window.addEventListener('resize', onWindowResize, false);
            
            // Update data rate display
            setInterval(() => {
                document.getElementById('data-rate').textContent = dataRate.toFixed(0) + ' Hz';
                dataRate = 0;
            }, 1000);
            
            // Start animation loop
            animate();
        }

        // --- Serial Communication ---
        async function toggleSerialConnection() {
            if (port) await disconnectSerial();
            else await connectSerial();
        }
        
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                updateConnectionStatus(true);
                readLoop(); // Start the read loop
            } catch (e) {
                console.error("Connection failed:", e);
                updateConnectionStatus(false);
            }
        }

        async function disconnectSerial() {
            if (reader) {
                await reader.cancel(); // This will cause the readLoop to break
            }
        }

        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();

            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        // The reader has been canceled, usually by disconnectSerial()
                        break;
                    }
                    lineBuffer += value;
                    let lines = lineBuffer.split('\n');
                    while (lines.length > 1) {
                        const line = lines.shift().trim();
                        if (line && !line.startsWith('#')) processData(line);
                    }
                    lineBuffer = lines[0];
                }
            } catch (error) {
                // This will catch errors like the device being unplugged
                console.error("Read loop error:", error);
            } finally {
                // This cleanup runs whether the loop breaks or an error occurs
                reader.releaseLock();
                await readableStreamClosed.catch(() => {}); // Ignore abort errors
                await port.close();
                port = null;
                reader = null;
                updateConnectionStatus(false);
            }
        }

        function processData(data) {
            const parts = data.split(',');
            if (parts.length === 6) {
                const [w, x, y, z, tempF, accelG] = parts.map(parseFloat);
                if ([w, x, y, z, tempF, accelG].some(isNaN)) {
                    console.warn("Received corrupted data, skipping:", data);
                    return; 
                }
                
                // FIXED: Correct quaternion mapping for standard aerospace coordinates
                // The MPU9250 outputs quaternions in its own frame, we need to convert to Three.js frame
                // Three.js uses: Y-up, X-right, Z-forward
                // MPU9250 typically: Z-up, X-forward, Y-right
                
                // This mapping assumes the sensor is mounted with:
                // - X axis pointing forward
                // - Y axis pointing right
                // - Z axis pointing up
                // Adjust these if your sensor is mounted differently
                currentQuaternion.set(x, y, z, w);
                
                // Display quaternion norm for debugging (should be ~1.0)
                const norm = Math.sqrt(w*w + x*x + y*y + z*z);
                document.getElementById('quat-norm').textContent = norm.toFixed(3);
                
                // Update temperature and acceleration displays
                document.getElementById('temp-val').textContent = tempF.toFixed(2) + '째 F';
                document.getElementById('accel-val').textContent = accelG.toFixed(2) + ' G';
                
                // Track data rate
                dataRate++;
            } else {
                console.warn("Received malformed data, skipping:", data);
            }
        }
        
        function zeroPosition() {
            zeroOffsetQuaternion = currentQuaternion.clone().conjugate();
            console.log("Position zeroed at current orientation");
        }

        // --- 3D Rendering and Animation ---
        function animate() {
            requestAnimationFrame(animate);
            
            // Apply zero offset to get relative quaternion
            const relativeQuaternion = zeroOffsetQuaternion.clone().multiply(currentQuaternion);

            // Fix inverted roll and yaw by rotating 180째 around the forward axis
            const fixRotation = new THREE.Quaternion();
            fixRotation.setFromAxisAngle(new THREE.Vector3(0, 0, 1), Math.PI); // 180째 around Z
            relativeQuaternion.multiply(fixRotation);
            
            // Smooth the rotation using slerp
            modelGroup.quaternion.slerp(relativeQuaternion, 0.15);
            
            // Update angle readouts
            updateReadouts(modelGroup.quaternion);
            
            renderer.render(scene, camera);
        }
        
        function updateReadouts(q) {
            // Extract rotation angles directly from the quaternion matrix
            // This avoids Euler order confusion
            
            // Convert quaternion to rotation matrix elements we need
            const w = q.w, x = q.x, y = q.y, z = q.z;
            
            // Calculate yaw (rotation around vertical axis)
            const yaw = Math.atan2(2 * (w * y + x * z), 1 - 2 * (y * y + z * z));
            
            // Calculate pitch - using the roll formula
            const sinPitch = Math.atan2(2 * (w * x + y * z), 1 - 2 * (x * x + y * y));
            const pitch = sinPitch;  // Already in radians

            // Calculate roll - using the pitch formula  
            const sinRoll = 2 * (w * z - x * y);
            const roll = Math.abs(sinRoll) >= 1 ? 
                Math.sign(sinRoll) * Math.PI / 2 : Math.asin(sinRoll);
            
            // Convert to degrees and display
            // Add negative signs here if you need to invert specific axes
            document.getElementById('yaw-val').textContent = THREE.MathUtils.radToDeg(yaw).toFixed(2) + '째';
            document.getElementById('pitch-val').textContent = THREE.MathUtils.radToDeg(pitch).toFixed(2) + '째';
            document.getElementById('roll-val').textContent = THREE.MathUtils.radToDeg(roll).toFixed(2) + '째';
        }

        // --- UI Updates and Helpers ---
        function updateConnectionStatus(isConnected) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const zeroButton = document.getElementById('zero-button');
            const connectButton = document.getElementById('connect-button');

            if (isConnected) {
                statusDot.className = 'status-dot status-connected';
                statusText.textContent = 'Connected';
                connectButton.textContent = 'Disconnect';
                zeroButton.disabled = false;
            } else {
                statusDot.className = 'status-dot status-disconnected';
                statusText.textContent = 'Disconnected';
                connectButton.textContent = 'Connect';
                zeroButton.disabled = true;
                currentQuaternion.set(0,0,0,1);
                zeroOffsetQuaternion.set(0,0,0,1);
            }
        }
        
        // --- 3D Model Creation ---
        function createRocketModel() {
            const rocketModel = new THREE.Group();
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xd1d5db, metalness: 0.8, roughness: 0.2 });
            const accentMaterial = new THREE.MeshStandardMaterial({ color: 0xef4444, metalness: 0.5, roughness: 0.5 });
            
            // Main body
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 2.5, 32), bodyMaterial);
            rocketModel.add(body);
            
            // Nose cone
            const noseCone = new THREE.Mesh(new THREE.ConeGeometry(0.4, 1, 32), accentMaterial);
            noseCone.position.y = 1.75;
            rocketModel.add(noseCone);
            
            // Fins
            for (let i = 0; i < 3; i++) {
                const fin = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.8, 0.08), accentMaterial);
                const angle = (i / 3) * Math.PI * 2;
                fin.position.set(Math.cos(angle) * 0.5, -0.85, Math.sin(angle) * 0.5);
                fin.rotation.y = -angle;
                rocketModel.add(fin);
            }
            
            // Add coordinate axis helper (for debugging)
            const axesHelper = new THREE.AxesHelper(2);
            rocketModel.add(axesHelper);
            
            modelGroup = new THREE.Group();
            modelGroup.add(rocketModel);
            scene.add(modelGroup);
        }

        function createLighting() {
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const light = new THREE.DirectionalLight(0xffffff, 1.0);
            light.position.set(5, 10, 7.5);
            scene.add(light);
        }

        function createHelpers() {
            const gridHelper = new THREE.GridHelper(20, 20, 0x4b5563, 0x374151);
            scene.add(gridHelper);
            
            // Add world coordinate axes (for reference)
            const worldAxes = new THREE.AxesHelper(5);
            scene.add(worldAxes);
        }

        function onWindowResize() {
            const container = document.getElementById('container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // --- Start the Application ---
        init();
    </script>
</body>
</html>